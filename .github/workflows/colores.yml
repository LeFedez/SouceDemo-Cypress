name: Cypress Tests and Slack Notification

on:
  push:
    branches:
      - main

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests with Mochawesome
        uses: cypress-io/github-action@v6
        with:
          install-command: 'npm ci'
          command: 'npx cypress run --reporter mochawesome --reporter-options reportDir=cypress/results,overwrite=false,html=false,json=true'
        continue-on-error: true

      - name: Extract test summary
        if: always()
        run: |
          RESULTS_FILE="cypress/results/mochawesome.json"
          if [ -f "$RESULTS_FILE" ]; then
            echo "PASSED_TESTS=$(jq '.stats.passes' "$RESULTS_FILE")" >> "$GITHUB_ENV"
            echo "FAILED_TESTS=$(jq '.stats.failures' "$RESULTS_FILE")" >> "$GITHUB_ENV"
            echo "SKIPPED_TESTS=$(jq '.stats.skipped' "$RESULTS_FILE")" >> "$GITHUB_ENV"
            echo "TOTAL_TESTS=$(jq '.stats.tests' "$RESULTS_FILE")" >> "$GITHUB_ENV"
          else
            echo "No mochawesome.json found. Setting default values."
            echo "PASSED_TESTS=0" >> "$GITHUB_ENV"
            echo "FAILED_TESTS=0" >> "$GITHUB_ENV"
            echo "SKIPPED_TESTS=0" >> "$GITHUB_ENV"
            echo "TOTAL_TESTS=0" >> "$GITHUB_ENV"
          fi

      - name: Send Slack Notification with rtCamp Action
        if: always()
        uses: rtCamp/action-slack-notify@v2 # Usamos esta acci√≥n
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL_COLOR }} # Webhook de Slack
          SLACK_USERNAME: 'Cypress CI' # Nombre de usuario del bot en Slack
          SLACK_CHANNEL: '#tu-canal' # Opcional: Especifica el canal, si no lo tienes en el webhook
          # Determina el color basado en si hay fallas
          SLACK_COLOR: ${{ env.FAILED_TESTS > 0 && 'danger' || 'good' }} # 'danger' para rojo, 'good' para verde
          # Construye el mensaje con los resultados y el enlace
          SLACK_MESSAGE: |
            *Resultados de Pruebas Cypress* para el commit `<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha | slice(0, 7) }}>` en la rama `${{ github.ref_name }}`
            üìä Total: ${{ env.TOTAL_TESTS }}
            ‚úÖ Passed: ${{ env.PASSED_TESTS }}
            ‚ùå Failed: ${{ env.FAILED_TESTS }}
            ‚ö™Ô∏è Skipped: ${{ env.SKIPPED_TESTS }}
            üîó Ver workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SLACK_FOOTER: 'Powered by GitHub Actions' # Pie de p√°gina opcional
          SLACK_ICON_EMOJI: ':cypress:' # Opcional: un emoji para el icono del bot

      - name: Upload Cypress artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-results
          path: |
            cypress/videos/
            cypress/screenshots/
            cypress/results/mochawesome.json
          retention-days: 5